{
  "name": "query_1_lgg_uniprot",
  "collection": "hgnc_genes",
  "type": "aggregate",
  "pipeline": [
    {
      "$match": {
        "projects.TCGA-LGG": {
          "$exists": true
        }
      }
    },
    {
      "$project": {
        "hgnc_id": 1,
        "symbol": 1,
        "ensembl_gene_id": 1,
        "uniprot_ids": 1,
        "cases_array": {
          "$objectToArray": "$projects.TCGA-LGG.cases"
        }
      }
    },
    {
      "$unwind": "$cases_array"
    },
    {
      "$group": {
        "_id": {
          "hgnc_id": "$hgnc_id",
          "symbol": "$symbol",
          "ensembl_gene_id": "$ensembl_gene_id",
          "uniprot_ids": "$uniprot_ids"
        },
        "mean_tpm_unstranded": {
          "$avg": "$cases_array.v.tpm_unstranded"
        },
        "n_cases": {
          "$sum": 1
        }
      }
    },
    {
      "$project": {
        "_id": 0,
        "hgnc_id": "$_id.hgnc_id",
        "symbol": "$_id.symbol",
        "ensembl_gene_id": "$_id.ensembl_gene_id",
        "uniprot_ids": "$_id.uniprot_ids",
        "mean_tpm_unstranded": 1,
        "n_cases": 1
      }
    },
    {
      "$lookup": {
        "from": "uniprot_entries",
        "let": {
          "ids": "$uniprot_ids"
        },
        "pipeline": [
          {
            "$match": {
              "$expr": {
                "$in": [
                  "$_id",
                  {
                    "$ifNull": [
                      "$$ids",
                      []
                    ]
                  }
                ]
              }
            }
          },
          {
            "$project": {
              "_id": 0,
              "uniprot_id": "$_id",
              "protein_name": {
                "$arrayElemAt": [
                  "$protein.names",
                  0
                ]
              },
              "protein_length": "$protein.length",
              "function_cc": "$protein.function_cc",
              "go_molecular_function": "$go_terms.molecular_function"
            }
          }
        ],
        "as": "uniprot_annotations"
      }
    },
    {
      "$lookup": {
        "from": "gdc_cases",
        "pipeline": [
          {
            "$match": {
              "project_id": "TCGA-LGG"
            }
          },
          {
            "$project": {
              "_id": 0,
              "project_id": 1,
              "disease_type": 1,
              "primary_site": 1
            }
          }
        ],
        "as": "gdc_project"
      }
    },
    {
      "$addFields": {
        "project": {
          "$arrayElemAt": [
            "$gdc_project",
            0
          ]
        }
      }
    },
    {
      "$project": {
        "gdc_project": 0
      }
    },
    {
      "$sort": {
        "mean_tpm_unstranded": -1
      }
    },
    {
      "$limit": 100
    }
  ]
}
